<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中心极限定理终极演示 - 多分布模拟</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #7C3AED; /* Violet */
            --secondary-color: #10B981; /* Emerald */
            --bg-color: #F8FAFC;
            --card-bg: #FFFFFF;
            --text-main: #1E293B;
            --text-sub: #64748B;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            margin: 0;
            min-height: 100vh;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            margin: 0 0 0.5rem 0;
            color: #111;
        }

        p.subtitle {
            color: var(--text-sub);
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.5;
        }

        .container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 1.5rem;
            width: 100%;
            max-width: 1200px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            border: 1px solid #E2E8F0;
        }

        /* Form Controls */
        .control-group { margin-bottom: 1.25rem; }

        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        select, input[type="range"] {
            width: 100%;
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid #CBD5E1;
            background: #fff;
            font-size: 1rem;
        }

        input[type="range"] { cursor: pointer; }

        .value-display {
            float: right;
            color: var(--primary-color);
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        /* Buttons */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        button {
            padding: 0.75rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover { background-color: #6D28D9; }

        .btn-secondary {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        .btn-secondary:hover { background-color: #F5F3FF; }

        /* Stats */
        .stats-box {
            background: #F1F5F9;
            padding: 1rem;
            border-radius: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .stat-item small { display: block; color: var(--text-sub); font-size: 0.75rem; margin-bottom: 2px; }
        .stat-item strong { font-size: 1.25rem; color: var(--text-main); }

        /* Charts */
        .chart-wrapper {
            position: relative;
            height: 240px;
            width: 100%;
            margin-bottom: 1.5rem;
        }
        .chart-label {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.8rem;
            background: rgba(255,255,255,0.8);
            padding: 4px 8px;
            border-radius: 4px;
            pointer-events: none;
            font-weight: bold;
            color: var(--text-sub);
        }

    </style>
</head>
<body>

    <header>
        <h1>中心极限定理 (CLT) 通用模拟器</h1>
        <p class="subtitle">选择不同的原始分布，见证它们如何统一归于正态分布。</p>
    </header>

    <div class="container">
        <aside class="card">

            <div class="control-group">
                <label for="distSelect">1. 选择原始分布 (总体)</label>
                <select id="distSelect" onchange="changeDistribution()">
                    <option value="uniform">均匀分布 (Uniform)</option>
                    <option value="exponential">指数分布 (Exponential) - 严重偏斜</option>
                    <option value="bimodal">双峰分布 (Bimodal) - 两个极值</option>
                </select>
            </div>

            <div class="control-group">
                <label>2. 每次抽样的样本量 (N) <span id="nValue" class="value-display">30</span></label>
                <input type="range" id="sampleSize" min="1" max="100" value="30" oninput="updateSampleSize()">
                <div style="font-size: 0.75rem; color: #666; margin-top:4px; line-height:1.4;">
                    提示：对于偏斜或双峰分布，需要更大的 N 才能看到完美的钟形。
                </div>
            </div>

            <div class="stats-box">
                <div class="stat-item">
                    <small>模拟次数</small>
                    <strong id="simCount">0</strong>
                </div>
                <div class="stat-item">
                    <small>最新均值</small>
                    <strong id="currentMean">-</strong>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn-primary" id="startBtn" onclick="toggleSimulation()">开始模拟</button>
                <button class="btn-secondary" onclick="resetSimulation()">重置</button>
            </div>
        </aside>

        <main class="card">
            <div class="chart-wrapper">
                <div class="chart-label">总体分布 (Population)</div>
                <canvas id="popChart"></canvas>
            </div>

            <div class="chart-wrapper">
                <div class="chart-label">样本均值分布 (Sampling Distribution)</div>
                <canvas id="cltChart"></canvas>
            </div>
        </main>
    </div>

    <script>
        // --- 配置与状态 ---
        let currentDist = 'uniform';
        let sampleSize = 30;
        let isRunning = false;
        let animationId;

        const binCount = 60; // 直方图的柱子数量
        // 生成 0.00 到 1.00 的标签
        const labels = Array.from({length: binCount}, (_, i) => (i / binCount).toFixed(2));

        let histogramData = new Array(binCount).fill(0);
        let totalSimulations = 0;

        // --- Chart.js 初始化 ---

        // 1. 总体分布图表 (静态展示形状)
        const ctxPop = document.getElementById('popChart').getContext('2d');
        const popChart = new Chart(ctxPop, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '概率密度',
                    data: [], // 动态生成
                    borderColor: '#64748B',
                    backgroundColor: 'rgba(100, 116, 139, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    pointRadius: 0,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { display: true, ticks: { maxTicksLimit: 10 } },
                    y: { display: false }
                },
                plugins: { legend: { display: false } },
                animation: { duration: 500 }
            }
        });

        // 2. 均值分布图表 (动态累积)
        const ctxCLT = document.getElementById('cltChart').getContext('2d');
        const cltChart = new Chart(ctxCLT, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '频率',
                    data: histogramData,
                    backgroundColor: '#7C3AED',
                    barPercentage: 1.0,
                    categoryPercentage: 1.0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 }, // 关掉动画以提高性能
                scales: {
                    x: { display: true, title: {display:true, text: '均值 (0 - 1)'}, ticks: { maxTicksLimit: 10 } },
                    y: { display: false }
                },
                plugins: { legend: { display: false } }
            }
        });

        // --- 数学生成器 ---

        // 辅助：生成正态分布随机数 (Box-Muller transform)
        function randn_bm() {
            let u = 0, v = 0;
            while(u === 0) u = Math.random();
            while(v === 0) v = Math.random();
            return Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
        }

        const generators = {
            // 均匀分布: 0 到 1
            uniform: () => Math.random(),

            // 指数分布: 模拟排队时间等，高度偏斜
            // 原公式 -ln(U)/lambda. 这里 lambda=5，让大部分数据落在 0-1 之间
            exponential: () => {
                let val = -Math.log(1 - Math.random()) / 5;
                return val > 1 ? 1 : val; // 截断 visuals for chart simplicity
            },

            // 双峰分布: 模拟两极分化的意见
            // 50% 概率在 0.2 附近，50% 概率在 0.8 附近
            bimodal: () => {
                if (Math.random() < 0.5) {
                    return 0.2 + randn_bm() * 0.05; // 峰值在 0.2
                } else {
                    return 0.8 + randn_bm() * 0.05; // 峰值在 0.8
                }
            }
        };

        // --- 逻辑控制 ---

        function updatePopChart() {
            let data = [];
            // 根据数学公式画出"理论"形状
            for(let i=0; i<binCount; i++) {
                let x = i / binCount;
                let y = 0;

                if(currentDist === 'uniform') {
                    y = 1; // 平坦
                } else if (currentDist === 'exponential') {
                    y = Math.exp(-5 * x); // 指数衰减
                } else if (currentDist === 'bimodal') {
                    // 双高斯叠加
                    const g1 = Math.exp(-Math.pow(x - 0.2, 2) / (2 * 0.05 * 0.05));
                    const g2 = Math.exp(-Math.pow(x - 0.8, 2) / (2 * 0.05 * 0.05));
                    y = g1 + g2;
                }
                data.push(y);
            }
            popChart.data.datasets[0].data = data;

            // 特殊处理 Uniform 的图表类型，让它看起来更像方块
            popChart.data.datasets[0].stepped = (currentDist === 'uniform');
            popChart.update();
        }

        function changeDistribution() {
            currentDist = document.getElementById('distSelect').value;
            resetSimulation();
            updatePopChart();
        }

        function updateSampleSize() {
            sampleSize = parseInt(document.getElementById('sampleSize').value);
            document.getElementById('nValue').innerText = sampleSize;
            resetSimulation();
        }

        // 核心循环
        function loop() {
            if (!isRunning) return;

            let currentBatchMean = 0; // 记录当前批次最后一个均值

            // 批量处理以提高速度
            for(let k=0; k<50; k++) {
                let sum = 0;
                // 1. 抽取 N 个样本
                for(let i=0; i<sampleSize; i++) {
                    // 2. 根据选中的分布生成随机数
                    let val = generators[currentDist]();
                    // 简单的边界保护
                    if(val < 0) val = 0;
                    if(val > 1) val = 1;
                    sum += val;
                }

                // 3. 计算均值
                let mean = sum / sampleSize;
                currentBatchMean = mean; // 更新当前均值

                // 4. 放入直方图
                let binIdx = Math.floor(mean * binCount);
                if(binIdx >= binCount) binIdx = binCount - 1;
                histogramData[binIdx]++;
                totalSimulations++;
            }

            // 更新UI
            document.getElementById('simCount').innerText = totalSimulations.toLocaleString();
            document.getElementById('currentMean').innerText = currentBatchMean.toFixed(4);

            cltChart.update();
            animationId = requestAnimationFrame(loop);
        }

        function toggleSimulation() {
            const btn = document.getElementById('startBtn');
            if (isRunning) {
                isRunning = false;
                btn.innerText = "继续模拟";
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                cancelAnimationFrame(animationId);
            } else {
                isRunning = true;
                btn.innerText = "暂停";
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
                loop();
            }
        }

        function resetSimulation() {
            isRunning = false;
            cancelAnimationFrame(animationId);

            // 清空数据
            histogramData.fill(0);
            totalSimulations = 0;

            // 重置UI
            document.getElementById('simCount').innerText = "0";
            document.getElementById('currentMean').innerText = "-";
            document.getElementById('startBtn').innerText = "开始模拟";
            document.getElementById('startBtn').classList.add('btn-primary');
            document.getElementById('startBtn').classList.remove('btn-secondary');

            cltChart.update();
        }

        // 初始化
        updatePopChart();
    </script>
</body>
</html>
